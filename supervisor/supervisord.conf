; supervisor/supervisord.conf
[unix_http_server]
file=/var/run/supervisor.sock   ; 确保此路径存在且可写

[supervisord]
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
nodaemon=true   ; 必须为true，以便 Docker 容器能保持运行
user=root       ; 容器内建议使用root，方便调试

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

; --- 您的程序配置 ---

[program:redis]
command=redis-server
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/redis_err.log
stdout_logfile=/var/log/supervisor/redis_out.log

[program:rq_worker_high]
command=/usr/local/bin/rq worker deepseek_tasks --with-scheduler ; 修改为监听 deepseek_tasks 队列
directory=/app
autostart=true
autorestart=true
stderr_logfile=/app/logs/worker_high.err.log
stdout_logfile=/app/logs/worker_high.out.log

[program:rq_worker_default]
command=/usr/local/bin/rq worker deepseek_tasks --with-scheduler ; 修改为监听 deepseek_tasks 队列
directory=/app
autostart=true
autorestart=true
stderr_logfile=/app/logs/worker_default.err.log
stdout_logfile=/app/logs/worker_default.out.log

[program:rq_worker_low]
command=/usr/local/bin/rq worker deepseek_tasks --with-scheduler ; 修改为监听 deepseek_tasks 队列
directory=/app
autostart=true
autorestart=true
stderr_logfile=/app/logs/worker_low.err.log
stdout_logfile=/app/logs/worker_low.out.log

[program:fastapi_api]
command=uvicorn web.app:app --host 0.0.0.0 --port 8000
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/fastapi_err.log
stdout_logfile=/var/log/supervisor/fastapi_out.log

; 移除 [include] 段落，因为所有程序都已直接定义在此文件中
; [include]
; files = /etc/supervisor/conf.d/*.conf