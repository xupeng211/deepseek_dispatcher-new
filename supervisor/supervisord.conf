[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=10MB
logfile_backups=5
loglevel=info
pidfile=/tmp/supervisord.pid

# Redis 服务配置
[program:redis]
command=redis-server /etc/redis/redis.conf
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis.err.log

# RQ Worker - high 队列
[program:rq_worker_high]
command=python /app/worker.py high # <-- 检查你的 worker 脚本路径
directory=/app
autostart=true
autorestart=true
numprocs=1
process_name=%(program_name)s_%(process_num)02d
stdout_logfile=/app/logs/%(program_name)s.out.log
stderr_logfile=/app/logs/%(program_name)s.err.log
redirect_stderr=true
user=root # 推荐在生产环境使用非root用户，这里为方便调试保持root

# RQ Worker - default 队列
[program:rq_worker_default]
command=python /app/worker.py default # <-- 检查你的 worker 脚本路径
directory=/app
autostart=true
autorestart=true
numprocs=1
process_name=%(program_name)s_%(process_num)02d
stdout_logfile=/app/logs/%(program_name)s.out.log
stderr_logfile=/app/logs/%(program_name)s.err.log
redirect_stderr=true
user=root

# RQ Worker - low 队列
[program:rq_worker_low]
command=python /app/worker.py low # <-- 检查你的 worker 脚本路径
directory=/app
autostart=true
autorestart=true
numprocs=1
process_name=%(program_name)s_%(process_num)02d
stdout_logfile=/app/logs/%(program_name)s.out.log
stderr_logfile=/app/logs/%(program_name)s.err.log
redirect_stderr=true
user=root

# FastAPI API 服务配置
# <-- **非常重要：请根据你的项目实际入口文件和应用实例名修改 'command' 这一行**
# 例如，如果你的 FastAPI 应用在 /app/src/api.py 中，实例名为 'web_app'，
# 那么 command 应该是 'uvicorn src.api:web_app --host 0.0.0.0 --port 8000'
[program:fastapi_api]
command=uvicorn main:app --host 0.0.0.0 --port 8000 # <-- 假设你的 FastAPI 应用在 /app/main.py，实例名为 'app'
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/fastapi_api.log
stderr_logfile=/var/log/supervisor/fastapi_api.err.log

# 如果你将所有配置都直接放到这个文件中，就不需要这个 [include] 段落了。
# 如果你确定 `/etc/supervisor/conf.d/` 目录下有单独的 .conf 文件，且内容正确，可以保留。
# 但为了确保所有服务启动，目前推荐直接把所有 [program] 放到这里。
# [include]
# files = /etc/supervisor/conf.d/*.conf